{% extends "blog/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <!-- Delete Form -->
    <div class="delete-form" style="display: none;">
        <form id="delete-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="form-group">
                <h2>Are you sure you want to delete this post?</h2>
            </fieldset>
            <div class="form-group">
                <button class="btn btn-outline-danger" name="action" value="delete" type="submit">Yes, delete</button>
                <button class="btn btn-outline-secondary cancel-btn">Cancel</button>
            </div>
        </form>
        <br>
    </div>
    <article class="media content-section">

        <div class="row">
            <div class="col-md-2">
                <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}">
            </div>
            <div class="col-md-10">
                <div class="media-body">
                    <div class="article-metadata">
                        <a class="mr-2" href="{% url 'profile' post.author.profile.id %}">{{ post.author }}</a>
                        <small class="text-muted">{{ post.created_at|date:"F d, Y" }}</small>
                        {% if post.author == user %}
                            <div>
                                <button class="btn btn-secondary btn-sm mt-1 mb-1 update-btn"
                                        data-pk="{{ post.pk }}">Update
                                </button>
                                <button class="btn btn-danger btn-sm mt-1 mb-1 delete-btn"
                                        data-pk="{{ post.pk }}">Delete
                                </button>
                            </div>
                        {% endif %}
                        <img class="article-img h-100 w-100" src="{{ post.image.url }}">
                    </div>
                    <p class="article-content">{{ post.content }}</p>
                    {% for tag in post.tags.all %}
                        <a style="text-decoration: none; color: inherit;" href="{% url 'search' %}?q={{ tag.name }}">
                            <span style="color:grey;font-size:15px;margin-bottom:5px;margin-left:0;,margin-top:0;"
                                  class="badge badge-primary">#{{ tag.name }}</span>
                        </a>
                    {% endfor %}
                    <br>
                    {% if user.is_authenticated %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="post_id" value="{{ post.pk }}">
                            {% if user in post.likes.all %}
                                <button class="btn btn-link" style="padding: 0; border: none;" name="action"
                                        value="unlike" type="submit">
                                    <i class="fas fa-heart" style="color: red; font-size: 24px;"></i>
                                </button>
                            {% else %}
                                <button class="btn btn-link" style="padding: 0; border: none;" name="action"
                                        value="like" type="submit">
                                    <i class="far fa-heart" style="color: gray; font-size: 24px;"></i>
                                </button>
                            {% endif %}
                        </form>
                    {% endif %}
                    {% if post.likes.all.count == 1 %}
                        <span style="color:grey;"> {{ post.likes.all.count }} like</span>
                    {% else %}
                        <span style="color:grey;"> {{ post.likes.all.count }} likes</span>
                    {% endif %}

                    <hr>
                    <h4>Comments</h4>
                    <div class="comments-section mt-4">
                        {% for comment in comments %}
                            <div class="media mb-4 p-3 border rounded bg-light align-items-center">
                                <img class="rounded-circle article-img mr-3"
                                     src="{{ comment.author.profile.image.url }}" alt="{{ comment.author }}">
                                <div class="media-body">
                                    <h5 class="mt-0 mb-1">{{ comment.author }}</h5>
                                    <small class="text-muted">{{ comment.created_at|date:"F d, Y" }}</small>
                                    <p class="mt-2">{{ comment.content }}</p>
                                </div>
                            </div>
                        {% empty %}
                            <p>No comments yet. Be the first to comment!</p>
                        {% endfor %}

                        {% if user.is_authenticated %}
                            <div class="mt-4">
                                <h5>Add a Comment</h5>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="comment">
                                    <div class="form-group">
                                        <textarea class="form-control" name="content" rows="3"
                                                  placeholder="Write your comment here..." required></textarea>
                                    </div>
                                    <button class="btn btn-primary btn-sm mt-2" type="submit">Post</button>
                                </form>
                            </div>

                        {% else %}
                            <p class="mt-4">You must be <a href="{% url 'login' %}">logged in</a> to comment.</p>
                        {% endif %}
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </article>

   <!-- Update Form -->
<div class="update-form" style="display: none;">
    <form id="update-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <fieldset class="form-group">
            <legend class="border-bottom mb-4">Update Post</legend>
            {{ form|crispy }}
        </fieldset>
        <div class="form-group">
            <br>
            <button class="btn btn-outline-info" name="action" value="update" type="submit">Submit</button>
            <button class="btn btn-outline-secondary cancel-btn">Cancel</button>
        </div>
    </form>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Show delete form when delete button is clicked
            $(".delete-btn").on("click", function () {
                $(".delete-form").show();
            });

            // Show update form when update button is clicked
            $(".update-btn").on("click", function () {
                $(".content-section").hide();
                $(".update-form").show();
            });

            // Cancel button functionality
            $(".cancel-btn").on("click", function (event) {
                event.preventDefault();
                $(".delete-form").hide();
                $(".update-form").hide();
                $(".content-section").show();
            });
        });
    </script>
{% endblock content %}
